rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return request.auth != null
        && request.auth.token.email in [
          'cristian3877@gmail.com',
          'nscri284@gmail.com',
          'admin@ventanas.cl',
          'admin@ejemplo.com'
        ];
    }

    // Reglas existentes para ventanas
    match /presupuestos/{budgetId} {
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      allow read: if isAuthenticated()
        && (
          resource.data.userId == request.auth.uid
          || isAdmin()
        );

      allow update, delete: if isAuthenticated()
        && (
          resource.data.userId == request.auth.uid
          || isAdmin()
        );
    }

    // NUEVAS REGLAS para Termopaneles
    match /presupuestos_termopaneles/{budgetId} {
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      allow read: if isAuthenticated()
        && (
          resource.data.userId == request.auth.uid
          || isAdmin()
        );

      allow update, delete: if isAuthenticated()
        && (
          resource.data.userId == request.auth.uid
          || isAdmin()
        );
    }

    // Reglas para Materiales (NUEVO: Soluciona el error de permisos)
    match /materiales/{materialId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /configuracion/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /configuracionAluminio/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /users/{userId} {
      // Permite que cada usuario maneje su propio perfil
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      
      // PERMITE QUE LOS ADMINS GESTIONEN TODOS LOS USUARIOS (Ver, Cambiar Roles, Eliminar)
      allow read, write: if isAdmin(); 
    }
  }
}
